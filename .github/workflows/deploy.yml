name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 158.69.113.159
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            # Definir directorio del proyecto
            PROJECT_DIR="/var/www/html/apielectoral/"
            
            # Verificar que el directorio existe
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "‚ùå Error: Directory $PROJECT_DIR does not exist"
              exit 1
            fi
            
            # Navegar al directorio del proyecto
            cd "$PROJECT_DIR"
            echo "‚úÖ Working directory: $(pwd)"
            
            # Verificar que es un repositorio git
            if [ ! -d .git ]; then
              echo "‚ùå Error: Not a git repository"
              exit 1
            fi
            
            # Configurar git safe.directory para evitar error de ownership
            git config --global --add safe.directory "$PROJECT_DIR"
            echo "‚úÖ Git safe directory configured"
            
            # Verificar y corregir permisos del directorio
            sudo chown -R ubuntu:ubuntu "$PROJECT_DIR"
            echo "‚úÖ Directory ownership corrected"
            
            # Hacer backup del .env si existe
            if [ -f .env ]; then
              cp .env .env.backup
              echo "‚úÖ Backed up .env file"
            else
              echo "‚ö†Ô∏è  Warning: .env file not found"
            fi
            
            # Pull latest changes
            echo "üì• Pulling latest changes..."
            git pull origin main || git pull origin master
            
            # Restaurar .env si existe el backup
            if [ -f .env.backup ]; then
              cp .env.backup .env
              echo "‚úÖ Restored .env file"
            fi
            
            # Limpiar venv corrupto si existe
            if [ -d venv ] && [ ! -f venv/bin/activate ]; then
              echo "üóëÔ∏è  Removing corrupted venv..."
              rm -rf venv
            fi
            
            # Verificar e instalar python3-venv si es necesario
            if ! dpkg -l | grep -q python3.*-venv; then
              echo "üì¶ Installing python3-venv..."
              sudo apt update -qq
              sudo apt install -y python3-venv python3-full
            fi
            
            # Crear virtual environment si no existe
            if [ ! -d venv ]; then
              echo "üì¶ Creating virtual environment..."
              python3 -m venv venv
              if [ $? -ne 0 ]; then
                echo "‚ùå Failed to create venv, installing dependencies..."
                sudo apt update -qq
                sudo apt install -y python3-venv python3-full python3-pip
                python3 -m venv venv
                if [ $? -ne 0 ]; then
                  echo "‚ùå Still failed, trying with sudo..."
                  sudo python3 -m venv venv
                  sudo chown -R ubuntu:ubuntu venv
                fi
              fi
            fi
            
            # Verificar que venv se cre√≥ correctamente
            if [ ! -f venv/bin/activate ]; then
              echo "‚ùå Virtual environment activation script not found"
              echo "üìã Debugging info:"
              echo "   Python version: $(python3 --version)"
              echo "   Python location: $(which python3)"
              echo "   Venv module: $(python3 -m venv --help > /dev/null 2>&1 && echo 'OK' || echo 'NOT FOUND')"
              exit 1
            fi
            
            # Activar entorno virtual
            source venv/bin/activate
            echo "‚úÖ Virtual environment activated"
            echo "   Python: $(which python)"
            echo "   Pip: $(which pip)"
            
            # Actualizar pip
            pip install --upgrade pip
            
            # Instalar/actualizar dependencias
            echo "üì¶ Installing dependencies..."
            pip install -r requirements.txt
            
            # Reiniciar el servicio si existe
            if sudo systemctl list-unit-files | grep -q "api-electoral.service"; then
              echo "üîÑ Restarting service..."
              sudo systemctl restart api-electoral
              sudo systemctl status api-electoral --no-pager
            else
              echo "‚ö†Ô∏è  Warning: api-electoral.service not found"
              echo "üí° You may need to set up the systemd service"
              
              # Intentar matar procesos existentes
              echo "üîç Checking for existing processes..."
              if pgrep -f "uvicorn.*api:app" > /dev/null; then
                echo "   Found existing uvicorn process, killing..."
                pkill -9 -f "uvicorn.*api:app" || true
                sleep 2
              elif pgrep -f "python.*api.py" > /dev/null; then
                echo "   Found existing python process, killing..."
                pkill -9 -f "python.*api.py" || true
                sleep 2
              else
                echo "   No existing processes found"
              fi
              
              # Iniciar aplicaci√≥n en background completamente desacoplada
              echo "üöÄ Starting application with uvicorn..."
              cd "$PROJECT_DIR"
              
              # Usar setsid y disown para desacoplar completamente del shell
              setsid venv/bin/uvicorn api:app --host 0.0.0.0 --port 8000 --workers 2 > app.log 2>&1 < /dev/null &
              APP_PID=$!
              disown
              
              echo "   Started with PID: $APP_PID"
              
              # Esperar a que inicie
              sleep 5
              
              # Verificar que est√° corriendo (buscar por nombre ya que puede tener otro PID)
              if pgrep -f "uvicorn.*api:app" > /dev/null; then
                ACTUAL_PID=$(pgrep -f "uvicorn.*api:app")
                echo "‚úÖ Application is running (PID: $ACTUAL_PID)"
              else
                echo "‚ùå Application failed to start"
                echo "üìã Last 30 lines of app.log:"
                tail -30 app.log 2>/dev/null || echo "   (log file not found)"
                exit 1
              fi
              
              # Verificar que responde
              echo "üîç Testing API endpoint..."
              sleep 3
              if curl -s http://localhost:8000/balance > /dev/null; then
                echo "‚úÖ API is responding"
              else
                echo "‚ö†Ô∏è  API not responding yet (may need more time to start)"
                echo "üìã Checking app.log for errors:"
                tail -10 app.log 2>/dev/null || echo "   (log file not found)"
              fi
            fi

      - name: Health Check
        run: |
          sleep 10
          curl -f http://158.69.113.159:8000/balance || echo "‚ö†Ô∏è Health check failed or endpoint not available"

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment to VPS successful!"
          echo "Server: 158.69.113.159"
          echo "Timestamp: $(date)"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå Deployment to VPS failed!"
          echo "Check logs for details"
          echo "Timestamp: $(date)"