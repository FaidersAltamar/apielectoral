name: Deploy FastAPI to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy FastAPI Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 158.69.113.159
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            set -e
            
            PROJECT_DIR="/var/www/html/apielectoral"
            
            echo "üöÄ Starting deployment..."
            
            # Ensure project directory exists
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "‚ùå Error: Directory $PROJECT_DIR does not exist"
              exit 1
            fi
            
            cd "$PROJECT_DIR"
            
            # Configure git
            git config --global --add safe.directory "$PROJECT_DIR"
            
            # Fix permissions
            sudo chown -R ubuntu:ubuntu "$PROJECT_DIR"
            
            # Stash any local changes
            echo "üíæ Stashing local changes..."
            git stash
            
            # Ensure remote is HTTPS
            CURRENT_REMOTE=$(git remote get-url origin)
            if [[ "$CURRENT_REMOTE" == git@* ]]; then
              echo "üîÑ Switching to HTTPS remote..."
              git remote set-url origin https://github.com/almanza023/apielectoral.git
            fi
            
            # Pull latest changes
            echo "üì• Pulling latest changes from repository..."
            git pull origin main || git pull origin master
            echo "‚úÖ Code updated"
            
            # Apply stashed changes if any
            git stash pop || echo "‚ÑπÔ∏è No stashed changes to apply"
            
            # Make deploy script executable
            chmod +x deploy.sh
            
            # Execute deployment script
            echo "üì¶ Executing deployment script..."
            bash deploy.sh

      - name: Health Check
        run: |
          sleep 10
          curl -f http://158.69.113.159:8000/balance || echo "‚ö†Ô∏è Health check failed or endpoint not available"

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment to VPS successful!"
          echo "Server: 158.69.113.159"
          echo "Timestamp: $(date)"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå Deployment to VPS failed!"
          echo "Check logs for details"
          echo "Timestamp: $(date)"