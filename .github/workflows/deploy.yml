name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 158.69.113.159
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            # Definir directorio del proyecto
            PROJECT_DIR="/var/www/html/apielectoral"
            
            # Verificar que el directorio existe
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "‚ùå Error: Directory $PROJECT_DIR does not exist"
              exit 1
            fi
            
            # Navegar al directorio del proyecto
            cd "$PROJECT_DIR"
            echo "‚úÖ Working directory: $(pwd)"
            
            # Verificar que es un repositorio git
            if [ ! -d .git ]; then
              echo "‚ùå Error: Not a git repository"
              exit 1
            fi
            
            # Hacer backup del .env si existe
            if [ -f .env ]; then
              cp .env .env.backup
              echo "‚úÖ Backed up .env file"
            else
              echo "‚ö†Ô∏è  Warning: .env file not found"
            fi
            
            # Pull latest changes
            echo "üì• Pulling latest changes..."
            git pull origin main || git pull origin master
            
            # Restaurar .env si existe el backup
            if [ -f .env.backup ]; then
              cp .env.backup .env
              echo "‚úÖ Restored .env file"
            fi
            
            # Crear virtual environment si no existe
            if [ ! -d venv ]; then
              echo "üì¶ Creating virtual environment..."
              python3 -m venv venv
            fi
            
            # Activar entorno virtual
            source venv/bin/activate
            echo "‚úÖ Virtual environment activated"
            
            # Actualizar pip
            pip install --upgrade pip
            
            # Instalar/actualizar dependencias
            echo "üì¶ Installing dependencies..."
            pip install -r requirements.txt
            
            # Reiniciar el servicio si existe
            if sudo systemctl list-unit-files | grep -q "api-electoral.service"; then
              echo "üîÑ Restarting service..."
              sudo systemctl restart api-electoral
              sudo systemctl status api-electoral --no-pager
            else
              echo "‚ö†Ô∏è  Warning: api-electoral.service not found"
              echo "üí° You may need to set up the systemd service"
              # Intentar matar procesos existentes y reiniciar manualmente
              pkill -f "python.*api.py" || true
              echo "üöÄ Starting application in background..."
              nohup venv/bin/python api.py > app.log 2>&1 &
              echo "‚úÖ Application started (PID: $!)" 
            fi

      - name: Health Check
        run: |
          sleep 10
          curl -f http://158.69.113.159:8000/balance || echo "‚ö†Ô∏è Health check failed or endpoint not available"

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment to VPS successful!"
          echo "Server: 158.69.113.159"
          echo "Timestamp: $(date)"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå Deployment to VPS failed!"
          echo "Check logs for details"
          echo "Timestamp: $(date)"